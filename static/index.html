<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0">
<title>高専プロコン掲示板#33</title>

<link rel="stylesheet" href="https://unpkg.com/sakura.css/css/sakura.css" type="text/css">
</head>
<body>

<h1>高専プロコン掲示板#33</h1>

<div id=container></div>

<footer>
  <div>App: CC BY <a href=https://twitter.com/taisukef>@taisukef</a></div>
  <div><a href=https://github.com/codeforkosen/proconbbs>src on GitHub</a></div>
  <script type="module" src="https://code4fukui.github.io/qr-code/qr-code.js"></script>
  <qr-code></qr-code>
</footer>
</body>

<script type="module">
import { fetchJSON } from "https://js.sabae.cc/fetchJSON.js";
import { enc } from "https://js.sabae.cc/enc.js";
import { DateTime } from "https://code4fukui.github.io/day-es/DateTime.js";
import { TrustData } from "https://code4fukui.github.io/DataWithTrust/TrustData.js";
import { Base16 } from "https://code4fukui.github.io/Base16/Base16.js";

const getUser = () => {
  const did = localStorage.getItem("did");
  const secret = localStorage.getItem("secret");
  const nickname = localStorage.getItem("nickname");
  if (did && secret) {
    return { did: Base16.decode(did), secret: Base16.decode(secret), nickname };
  }
  {
    const user = TrustData.createUser();
    localStorage.setItem("did", Base16.encode(user.did));
    localStorage.setItem("secret", Base16.encode(user.secret));
    user.nickname = prompt("ニックネームを入力ください") || "noname";
    localStorage.setItem("nickname", user.nickname);
    return user;
  }
};

const data = await fetchJSON("api/list");
container.innerHTML = "";
const cr = (tag, p) => {
  const c = document.createElement(tag);
  if (p) {
    p.appendChild(c);
  }
  return c;
};
for (const t of data) {
  const topic = cr("div", container);
  topic.className = "topic";
  const name = cr("div", topic);
  const items = t.items;
  name.textContent = t.type.substring(0, 2) + '-' + t.num + ': ' + t.title + t.description + " by " + t.kosen + " (" + items.length + "件)";
  const comments = cr("div", topic);
  comments.style.display = "none";
  comments.className = "comments";
  const addComment = (d, parent) => {
    console.log(d, parent);
    const div = cr("div", parent);
    div.className = "bbsitem";
    div.innerHTML = `<span class=date>${enc(new DateTime(d.date).toStringMin().substring(5))}</span>
    by <span class=name title=${d.did}>${d.nickname}</span>
      <div class=body>${enc(d.body)}</div>`;
    return div;
  };
  console.log(items)
  items.forEach(d => addComment(d, comments));

  const combox = cr("div", comments);
  const inp = cr("input", combox);
  const btn = cr("button", combox);
  btn.textContent = "送信";

  name.onclick = () => {
    if (comments.style.display == "none") {
      comments.style.display = "block";
    } else {
      comments.style.display = "none";
    }
  };

  const write = async (item) => {
    if (await fetchJSON("api/add", item) != "ok") {
      alert("書き込みに失敗しました");
      return false;
    }
    return true;
  };
  btn.onclick = async () => {
    const user = getUser();
    console.log(user);
    const comment = inp.value;
    const item = {
      id: t.id,
      did: Base16.encode(user.did),
      nickname: user.nickname,
      body: comment,
      date: new DateTime().toString(),
    };
    if (await write(item)) {
      inp.value = "";
      const add = addComment(item, null);
      comments.insertBefore(add, combox);
    }
  };
}
</script>

<style>
.topic {
  margin-bottom: 16px;
}

.comments {
  padding-left: 1em;
  margin-bottom: 8px;
}
.bbsitem {
  padding-bottom: 2px;
  border-bottom: 1px solid gray;
  margin-bottom: 8px;
}
.bbsitem div {
  display: inline-block;
  margin-left: 1em;
}
.comments input {
  width: 70vw;
  font-size: 16px;
}
</style>
  
</html>
